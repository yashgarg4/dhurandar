<!-- File: index.html -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Dhurandar</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"
    />
    <meta name="generator" content="Scirra Construct" />
    <meta name="author" content="JioGames" />
    <link rel="manifest" href="appmanifest.json" />
    <link rel="apple-touch-icon" sizes="128x128" href="icons/icon-128.png" />
    <link rel="apple-touch-icon" sizes="256x256" href="icons/icon-256.png" />
    <link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png" />
    <link rel="icon" type="image/png" href="icons/icon-512.png" />
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <script>
      if (location.protocol.substr(0, 4) === "file") {
        alert(
          "Web exports won't work until you upload them. (When running on the file: protocol, browsers block many features from working for security reasons.)"
        );
      }
    </script>

    <noscript>
      <div id="notSupportedWrap">
        <h2 id="notSupportedTitle">This content requires JavaScript</h2>
        <p class="notSupportedMessage">
          JavaScript appears to be disabled. Please enable it to view this
          content.
        </p>
      </div>
    </noscript>

    <script src="scripts/modernjscheck.js"></script>
    <script src="scripts/supportcheck.js"></script>
    <script src="scripts/offlineclient.js" type="module"></script>
    <script src="scripts/main.js" type="module"></script>
    <script src="scripts/register-sw.js" type="module"></script>

    <!-- PipePuzzle iframe overlay (integrator) -->
    <style>
      #pipepuzzle_iframe_wrap {
        position: fixed;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.6);
        z-index: 99999;
        /* default non-interactive when hidden */
        pointer-events: none;
      }
      .pipepuzzle_iframe {
        width: 960px;
        height: 640px;
        border: none;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
        border-radius: 8px;
        background: #000;
      }
      @media (max-width: 1000px) {
        .pipepuzzle_iframe {
          width: 100%;
          height: 100%;
          border-radius: 0;
        }
      }
      /* Optional close hint */
      #pipepuzzle_close_hint {
        position: absolute;
        top: 12px;
        right: 12px;
        z-index: 100000;
        background: rgba(0, 0, 0, 0.5);
        color: #fff;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 14px;
        user-select: none;
        -webkit-user-select: none;
        display: none;
      }
      #pipepuzzle_iframe_wrap.show #pipepuzzle_close_hint {
        display: block;
      }
    </style>

    <div
      id="pipepuzzle_iframe_wrap"
      aria-hidden="true"
      role="dialog"
      tabindex="-1"
    >
      <!-- <div id="pipepuzzle_close_hint">Tap outside to close</div> -->
      <!-- iframe inserted dynamically -->
    </div>

    <script>
      // Integration script - dynamic iframe lifecycle to avoid stale pointer capture
      (function () {
        const iframeWrap = document.getElementById("pipepuzzle_iframe_wrap");
        const closeHint = document.getElementById("pipepuzzle_close_hint");
        // Path inside export where PipePuzzlee is placed (adjust if needed)
        const PIPE_URL = "./PipePuzzlee/index.html";
        let iframe = null;

        // Utility: find game canvas (best-effort)
        function findGameCanvas() {
          // prefer common Construct canvas ids if present, else first canvas
          return (
            document.getElementById("c2canvas") ||
            document.getElementById("c3canvas") ||
            document.querySelector("canvas")
          );
        }

        // wake parent input by focusing + dispatching pointer events
        function wakeParentInput() {
          try {
            // Allow body and game container to receive pointers
            document.body.style.pointerEvents = "auto";
            document.body.style.touchAction = "auto";
            // Focus window and canvas
            if (window.focus) window.focus();
            const canvas = findGameCanvas();
            if (canvas) {
              if (typeof canvas.focus === "function") {
                try {
                  canvas.focus();
                } catch (e) {}
              }
              // dispatch pointer and mouse fallback events
              try {
                const pUp = new PointerEvent("pointerup", {
                  bubbles: true,
                  cancelable: true,
                });
                canvas.dispatchEvent(pUp);
                const pCancel = new PointerEvent("pointercancel", {
                  bubbles: true,
                  cancelable: true,
                });
                canvas.dispatchEvent(pCancel);
              } catch (e) {
                try {
                  const mu = new MouseEvent("mouseup", {
                    bubbles: true,
                    cancelable: true,
                  });
                  canvas.dispatchEvent(mu);
                } catch (ee) {}
              }
            }
          } catch (e) {
            console.warn("wakeParentInput failed", e);
          }
        }

        // open: create iframe, attach, show overlay and enable pointer-events
        window.openPipePuzzle = function (url) {
          try {
            // If already open, ignore
            if (iframe) return;
            iframe = document.createElement("iframe");
            iframe.className = "pipepuzzle_iframe";
            iframe.id = "pipepuzzle_iframe";
            iframe.src = url || PIPE_URL;
            iframe.title = "PipePuzzle";
            iframe.setAttribute(
              "allow",
              "fullscreen; autoplay; clipboard-read; clipboard-write"
            );
            // Prevent clicks inside iframe from closing overlay: stop propagation on wrapper click handler by checking target
            iframeWrap.appendChild(iframe);

            // show overlay and make interactive
            iframeWrap.style.display = "flex";
            iframeWrap.classList.add("show");
            iframeWrap.style.pointerEvents = "auto";
            iframeWrap.setAttribute("aria-hidden", "false");

            // try focusing iframe after load for keyboard input
            iframe.addEventListener(
              "load",
              () => {
                try {
                  iframe.contentWindow &&
                    iframe.contentWindow.focus &&
                    iframe.contentWindow.focus();
                } catch (e) {}
              },
              { once: true }
            );
          } catch (e) {
            console.error("openPipePuzzle failed", e);
          }
        };

        // close: remove iframe element, hide overlay, restore parent input and wake it
        window.closePipePuzzle = function () {
          try {
            if (iframe) {
              // try best-effort to stop iframe internal activity
              try {
                iframe.src = "about:blank";
              } catch (e) {}
              // remove DOM node
              try {
                iframe.remove();
              } catch (e) {
                iframe.parentNode && iframe.parentNode.removeChild(iframe);
              }
              iframe = null;
            }
            // hide overlay and make it non-interactive
            iframeWrap.style.display = "none";
            iframeWrap.classList.remove("show");
            iframeWrap.style.pointerEvents = "none";
            iframeWrap.setAttribute("aria-hidden", "true");

            // small delay to allow DOM reflow before waking input
            setTimeout(wakeParentInput, 40);
          } catch (e) {
            console.warn("closePipePuzzle error", e);
          }
        };

        // Close when clicking outside iframe (overlay background). If click target is the wrapper (not the iframe), close.
        iframeWrap.addEventListener("click", function (ev) {
          // if click/touch was directly on wrapper (not inside iframe), close
          if (ev.target === iframeWrap) {
            // allow a short delay to avoid accidental taps closing immediately
            window.closePipePuzzle && window.closePipePuzzle();
          }
        });

        // Also handle escape key to close overlay
        window.addEventListener("keydown", function (ev) {
          if (ev.key === "Escape" && iframe) {
            window.closePipePuzzle && window.closePipePuzzle();
          }
        });

        // PostMessage listener from PipePuzzle iframe
        window.addEventListener(
          "message",
          function (event) {
            try {
              const data = event.data;
              if (!data || !data.type) return;
              if (data.type === "levelComplete") {
                window.closePipePuzzle();
                console.log(
                  "Parent received levelComplete from PipePuzzle",
                  data
                );
                try {
                  if (
                    window.runtime &&
                    typeof window.runtime.callFunction === "function"
                  ) {
                    window.runtime.callFunction(
                      "FromIframe",
                      JSON.stringify(data)
                    );
                  } else if (typeof window.CallFunction === "function") {
                    window.CallFunction("FromIframe", JSON.stringify(data));
                  } else {
                    console.warn(
                      'Construct runtime.callFunction not found. Add a Function event "FromIframe" or adjust integration.'
                    );
                  }
                } catch (e) {
                  console.warn("Error calling Construct function:", e);
                }
              }
            } catch (e) {
              console.warn(e);
            }
          },
          false
        );

        // Debug helper
        console.log(
          "PipePuzzle integration ready. Call window.openPipePuzzle() to open the embedded level."
        );
      })();
    </script>
  </body>
</html>
